{% extends 'base.html' %}

{% block content %}
<h2>Chat k filmu: {{ movie.title }}</h2>

<div id="chat-box" style="border: 1px solid #444; padding: 10px; height: 320px; overflow-y: auto; margin-bottom: 10px;">
</div>

<form action="" id="chat-form" style="display: flex; gap: 8px;">
    <input type="text" id="chat-input" placeholder="Napiš zprávu..." autocomplete="off" style="flex:1;">
    <button type="submit">Odeslat</button>
</form>

<script>
  const wsKind = "{{ ws_kind }}"; // "movie"
  const wsId = "{{ ws_id }}";     // movie.id
  const currentUsername = "{{ request.user.username|escapejs }}";

  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const socketUrl = `${protocol}://${window.location.host}/ws/chat/${wsKind}/${wsId}/`;

  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");

  function appendMessage({sender, text, created_at}) {
    const mine = sender === currentUsername;
    console.log("mine:", mine);
    console.log("sender:", sender);
    console.log("currentUsername:", currentUsername);
    console.log("content:", text);
    const time = created_at ? new Date(created_at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "";
    const p = document.createElement("p");
    p.style.margin = "6px 0";
    p.innerHTML = `<strong>${mine ? "Já" : sender}:</strong> ${text} <small style="color:#888;">${time}</small>`;
    {#console.log("p:", p);#}
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  const socket = new WebSocket(socketUrl);
  console.log("socket:", socket);

  socket.onmessage = (e) => {
    {#const data = JSON.parse(e.data);#}
    console.log("WS RAW: ", e.data);
    {#console.log("WS RAW: ", e.data);#}
    let data;
    try{
        data = JSON.parse(e.data);
    } catch (err) {
        console.warn("WS non-JSON message", e.data);
        return;
    }
    console.log("DATA TYPE: ", data.type);

    if ((data.type === "history" || data.type === "chat.history") && Array.isArray(data.messages)) {
      chatBox.innerHTML = "";
      data.messages.forEach(m => appendMessage(m));
      {#console.log("data.messages", data, data.messages);#}
      return;
    }

    /* - spatny type/ nefunkční
    if (data.type === "message") {
      appendMessage(data);
    }
    */

    if (data.type === "chat.message" || data.type === "message") {
        appendMessage(data);
    }
  };

  socket.onopen = () => {
    console.log("WS OPEN:", socketUrl);
    };

  socket.onclose = (e) => {
    console.log("WS CLOSED. code=", e.code, "reason=", e.reason);
    };

  if (!chatForm || !chatBox || !chatInput) {
      console.warn("Chat elements missing in chat", {chatForm, chatInput, chatBox});
  } else {
    chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;

    if (socket.readyState !== WebSocket.OPEN) {
            console.log("Socket není otevřený", socket.readyState);
            return;
        }

    socket.send(JSON.stringify({text}));
    {#console.log("text from input", text);#}
    {#const pa = document.createElement("p");#}
    {#pa.innerHTML = `<strong>new:</strong> ${text} <small style="color:#888;">čas</small>`;#}
    {#pa.style.margin = "6px 0";#}
    {#chatBox.appendChild(pa);#}
    {#console.log("data.type:", e)#}
    {#chatBox.scrollTop = chatBox.scrollHeight;#}
    chatInput.value = "";
    chatInput.focus();
    });
  }


</script>

{% endblock %}
