{% extends 'base.html' %}

{% block content %}
    <div class="container py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Chat k filmu: {{ movie.title }}</h2>
            <a class="btn btn-sm bt-outline-secondary" href="{% url 'movie_detail' movie.slug %}">Zpět na Film</a>
        </div>

        <div id="chat-box" class="border rounded p-3 mb-3" style="height: 55vh; overflow-y: auto;"></div>

        <form id="chat-form" class="d-flex gap2">
            {% csrf_token %}
            <input type="text" name="" id="chat-input" class="form-control" placeholder="Napiš zprávu..." autocomplete="off">
            <button type="submit" class="btn btn-primary">Odeslat</button>
        </form>
    </div>

<script>
(function () {
    const wsKind = "{{ ws_kind }}"; // "movie"
    const wsId = "{{ ws_id }}";     // movie.id
    const currentUsername = "{{ request.user.username|escapejs }}";

    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const socketUrl = `${protocol}://${window.location.host}/ws/chat/${wsKind}/${wsId}/`;

    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    function appendMessage({sender, text, created_at}) {
        const mine = sender === currentUsername;
        {#console.log("mine:", mine);#}
        {#console.log("sender:", sender);#}
        {#console.log("currentUsername:", currentUsername);#}
        {#console.log("content:", text);#}
        const time = created_at ? new Date(created_at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "";
        const p = document.createElement("p");
        p.className = "mb-2"
        p.style.margin = "6px 0";
        p.innerHTML = `<strong>${mine ? "Já" : sender}:</strong> ${text} <small class="text-muted">${time}</small>`;
        {#console.log("p:", p);#}
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    const socket = new WebSocket(socketUrl);
    {#console.log("socket:", socket);#}

    socket.onmessage = (e) => {
        let data;
        try{
            data = JSON.parse(e.data);
        } catch {
            return;
        }

        if ((data.type === "history" || data.type === "chat.history") && Array.isArray(data.messages)) {
          chatBox.innerHTML = "";
          data.messages.forEach(appendMessage);
          return;
        }

        if (data.type === "chat.message" || data.type === "message") {
            appendMessage(data);
        }

    };


/*    socket.onopen = () => {
    console.log("WS OPEN:", socketUrl);
    };

    socket.onclose = (e) => {
    console.log("WS CLOSED. code=", e.code, "reason=", e.reason);
    };
*/
    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        if (socket.readyState !== WebSocket.OPEN) return;

        socket.send(JSON.stringify(text));
        chatInput.value = "";
        chatInput.focus();
    });
    })()
</script>
{% endblock %}

